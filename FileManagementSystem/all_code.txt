# --- /home/ko_linux/FileManagementTool/FileManagementSystem/auth.py ---
import bcrypt, base64

def hash_password(password):
    salt = bcrypt.gensalt()
    hashed = bcrypt.hashpw(password.encode('utf-8'), salt)
    hashed_b64 = base64.b64encode(hashed).decode('utf-8')
    return hashed_b64

def authenticate(password: str, stored_hash_b64: str) -> bool:
    """Check password against Base64-encoded stored hash"""
    stored_hash = base64.b64decode(stored_hash_b64.encode("utf-8"))
    return bcrypt.checkpw(password.encode("utf-8"), stored_hash)

if __name__ == "__main__":
    # Example usage
    stored = hash_password("test1234")
    print("Stored hash (Base64):", stored)

    if authenticate("test1234", stored):
        print("auth")
    else:
        print("notauth")

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/main.py ---
from app import create_app
from config import CONFIG

config = CONFIG()
app = create_app()

if __name__ == "__main__":
    app.run(
        debug=True,
        host=config["HOST"],
        port=config["PORT"],
    )


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/init_db.py ---
from app.services.db_init_service import initialize_database
from database.db import DBCursor
from config import CONFIG

config = CONFIG()

def init_db():
    print(f"[INIT] Using DB at: {config['SQL_ADDRESS']}")

    try:
        with DBCursor() as cur:
            result = initialize_database(cur)
            print(f"[INIT] Result: {result}")

    except Exception as e:
        print(f"[INIT] Database initialization failed: {e}")
        raise

if __name__ == "__main__":
    init_db()

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/config.json ---
{
  "HOST": "0.0.0.0",
  "PORT": 5000,
  "DB_HOST": "localhost",
  "DB_PORT": 5432,
  "DB_NAME": "testarray"
}


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/sql_loader.py ---
import os

class SQL_COMMANDS(dict):
    def __init__(self):
        root = os.path.dirname(os.path.abspath(__file__))
        sql_dir = os.path.join(root, "sql")
        super().__init__(sql_commands_loader(sql_dir))

def sql_commands_loader(sql_dir) -> dict:
    sql_dict = dict()
    for root, dirs, files in os.walk(sql_dir):
        for file in files:
            if file.endswith(".sql"):
                full_path = os.path.join(root, file)
                filename, _ = os.path.splitext(file)
                with open(full_path, "r", encoding="utf-8") as f:
                    content = f.read()
                sql_dict[filename] = content
    return sql_dict
    

if __name__ == "__main__":
    sql_commands = SQL_COMMANDS()
    print(sql_commands)


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/config.py ---
import json
import os
from dotenv import load_dotenv

load_dotenv()  # loads .env in dev, does nothing in prod

class CONFIG(dict):
    def __init__(self):
        data = read_json("config.json")

        user = os.getenv("DB_USER")
        password = os.getenv("DB_PASSWORD")

        if not user or not password:
            raise RuntimeError("DB_USER or DB_PASSWORD not set")

        data["SQL_ADDRESS"] = (
            f"postgresql://{user}:{password}"
            f"@{data['DB_HOST']}:{data['DB_PORT']}/{data['DB_NAME']}"
        )

        jwt_secret = os.getenv("JWT_SECRET_KEY")
        if not jwt_secret:
            raise RuntimeError("JWT_SECRET_KEY not set")
        data["JWT_SECRET_KEY"] = jwt_secret

        super().__init__(data)


def read_json(file):
    with open(file) as f:
        return json.load(f)


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/requirements.txt ---
apispec==6.9.0
bcrypt==4.3.0
blinker==1.9.0
click==8.2.1
dotenv==0.9.9
Flask==3.1.2
Flask-JWT-Extended==4.7.1
flask-smorest==0.46.2
itsdangerous==2.2.0
Jinja2==3.1.6
MarkupSafe==3.0.2
marshmallow==4.2.0
packaging==25.0
psycopg==3.3.2
psycopg-binary==3.3.2
PyJWT==2.10.1
python-dotenv==1.2.1
typing_extensions==4.15.0
webargs==8.7.1
Werkzeug==3.1.3


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/scrapper.py ---
import os

def collect_code(root_dir, output_file):
    with open(output_file, "w", encoding="utf-8") as outfile:
        for dirpath, dirnames, filenames in os.walk(root_dir):
            # Exclude .venv and __pycache__ directories
            dirnames[:] = [d for d in dirnames if d not in (".venv", "__pycache__", "scrapper.py")]

            for filename in filenames:
                filepath = os.path.join(dirpath, filename)
                try:
                    with open(filepath, "r", encoding="utf-8") as infile:
                        outfile.write(f"# --- {filepath} ---\n")
                        outfile.write(infile.read())
                        outfile.write("\n\n")
                except Exception as e:
                    print(f"Skipping {filepath} due to error: {e}")

if __name__ == "__main__":
    project_root = os.path.dirname(os.path.abspath(__file__))  # current folder
    output_txt = "all_code.txt"
    collect_code(project_root, output_txt)
    print(f"âœ… Code collected into {output_txt}")


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/all_code.txt ---


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/.env ---
DB_USER=admin
DB_PASSWORD=supersecret
JWT_SECRET_KEY=change-this-dev-only

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/database/db_utils.py ---
from database.db import DBCursor

def db_route(service_func, *args, **kwargs):
    with DBCursor() as cur:
        result = service_func(cur, *args, **kwargs)
    return result


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/database/db.py ---
from psycopg import Cursor, connect
from psycopg.rows import dict_row

from config import CONFIG

SQL_ADDRESS = CONFIG()["SQL_ADDRESS"]

class DBCursor:
    def __init__(self):
        self.conn = None
        self.cur = None

    def __enter__(self) -> Cursor:
        self.conn = connect(SQL_ADDRESS)
        self.cur = self.conn.cursor(row_factory=dict_row)
        self.cur.execute("SET search_path TO public")
        return self.cur

    def __exit__(self, exc_type, exc, tb):
        if exc_type is None:
            self.conn.commit()
        else:
            self.conn.rollback()

        self.cur.close()
        self.conn.close()

        # False = re-raise exception (important!)
        return False

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/sql/init.sql ---
CREATE TABLE IF NOT EXISTS "resolution" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "h" INTEGER NOT NULL,
  "w" INTEGER NOT NULL
);

CREATE UNIQUE INDEX IF NOT EXISTS resolution_hw_unique ON "resolution" ("h", "w");

CREATE TABLE IF NOT EXISTS "client" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "name" VARCHAR
);

CREATE TABLE IF NOT EXISTS "user_type" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "name" VARCHAR UNIQUE NOT NULL,
  "description" TEXT
);

INSERT INTO "user_type" (name, description)
VALUES
  ('regular', 'Default regular user'),
  ('admin', 'Administrator')
ON CONFLICT (name)
DO UPDATE SET description = EXCLUDED.description;


CREATE TABLE IF NOT EXISTS "status_set" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "name" VARCHAR UNIQUE
);

CREATE TABLE IF NOT EXISTS "status" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "status_set_id" INTEGER NOT NULL,
  "name" VARCHAR NOT NULL,
  "description" TEXT
);

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'status_status_set_fk'
  ) THEN
    ALTER TABLE "status"
      ADD CONSTRAINT status_status_set_fk
      FOREIGN KEY ("status_set_id") REFERENCES "status_set" ("id");
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS "scenario" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "name" VARCHAR UNIQUE
);

CREATE TABLE IF NOT EXISTS "test_suite" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "name" VARCHAR UNIQUE
);

CREATE TABLE IF NOT EXISTS "project" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "name" VARCHAR,
  "client_id" INTEGER NOT NULL
);

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'project_client_fk'
  ) THEN
    ALTER TABLE "project"
      ADD CONSTRAINT project_client_fk
      FOREIGN KEY ("client_id") REFERENCES "client" ("id");
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS "device" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "project_id" INTEGER NOT NULL,
  "name_external" VARCHAR,
  "name_internal" VARCHAR,
  "cpu" VARCHAR,
  "gpu" VARCHAR,
  "ram" VARCHAR
);

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'device_project_fk'
  ) THEN
    ALTER TABLE "device"
      ADD CONSTRAINT device_project_fk
      FOREIGN KEY ("project_id") REFERENCES "project" ("id");
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS "user_group" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "created_by_id" INTEGER NOT NULL,
  "owner_id" INTEGER NOT NULL,
  "name" VARCHAR UNIQUE
);

CREATE TABLE IF NOT EXISTS "user" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "user_group_id" INTEGER,
  "user_type_id" INTEGER NOT NULL,
  "first_name" VARCHAR NOT NULL,
  "last_name" VARCHAR NOT NULL,
  "email" VARCHAR NOT NULL,
  "password" VARCHAR NOT NULL,
  "active" BOOLEAN DEFAULT TRUE,
  "created_at" TIMESTAMP DEFAULT now(),
  "last_login_at" TIMESTAMP
);

CREATE UNIQUE INDEX IF NOT EXISTS user_email_unique ON "user" ("email");

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'user_user_type_fk'
  ) THEN
    ALTER TABLE "user"
      ADD CONSTRAINT user_user_type_fk
      FOREIGN KEY ("user_type_id") REFERENCES "user_type" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'user_user_group_fk'
  ) THEN
    ALTER TABLE "user"
      ADD CONSTRAINT user_user_group_fk
      FOREIGN KEY ("user_group_id") REFERENCES "user_group" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'user_group_created_by_fk'
  ) THEN
    ALTER TABLE "user_group"
      ADD CONSTRAINT user_group_created_by_fk
      FOREIGN KEY ("created_by_id") REFERENCES "user" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'user_group_owner_fk'
  ) THEN
    ALTER TABLE "user_group"
      ADD CONSTRAINT user_group_owner_fk
      FOREIGN KEY ("owner_id") REFERENCES "user" ("id");
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS "test_case" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "scenario_id" INTEGER NOT NULL,
  "status_set_id" INTEGER NOT NULL
);

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'test_case_scenario_fk'
  ) THEN
    ALTER TABLE "test_case"
      ADD CONSTRAINT test_case_scenario_fk
      FOREIGN KEY ("scenario_id") REFERENCES "scenario" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'test_case_status_set_fk'
  ) THEN
    ALTER TABLE "test_case"
      ADD CONSTRAINT test_case_status_set_fk
      FOREIGN KEY ("status_set_id") REFERENCES "status_set" ("id");
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS "test_case_version" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "test_case_id" INTEGER NOT NULL,
  "created_by" INTEGER NOT NULL,
  "release_ready" BOOLEAN DEFAULT FALSE,
  "version" INTEGER NOT NULL,
  "name" VARCHAR,
  "description" TEXT,
  "steps" TEXT,
  "expected_result" TEXT,
  "created_at" TIMESTAMP DEFAULT now()
);

CREATE UNIQUE INDEX IF NOT EXISTS test_case_version_unique
  ON "test_case_version" ("test_case_id", "version");

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'tcv_test_case_fk'
  ) THEN
    ALTER TABLE "test_case_version"
      ADD CONSTRAINT tcv_test_case_fk
      FOREIGN KEY ("test_case_id") REFERENCES "test_case" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'tcv_created_by_fk'
  ) THEN
    ALTER TABLE "test_case_version"
      ADD CONSTRAINT tcv_created_by_fk
      FOREIGN KEY ("created_by") REFERENCES "user" ("id");
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS "suitcase" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "test_case_id" INTEGER NOT NULL,
  "test_suite_id" INTEGER NOT NULL
);

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'suitcase_test_case_fk'
  ) THEN
    ALTER TABLE "suitcase"
      ADD CONSTRAINT suitcase_test_case_fk
      FOREIGN KEY ("test_case_id") REFERENCES "test_case" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'suitcase_test_suite_fk'
  ) THEN
    ALTER TABLE "suitcase"
      ADD CONSTRAINT suitcase_test_suite_fk
      FOREIGN KEY ("test_suite_id") REFERENCES "test_suite" ("id");
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS "run" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "name" VARCHAR,
  "started_at" TIMESTAMP,
  "done_at" TIMESTAMP,
  "test_suite_metadata" TEXT,
  "project_id" INTEGER NOT NULL
);

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'run_project_fk'
  ) THEN
    ALTER TABLE "run"
      ADD CONSTRAINT run_project_fk
      FOREIGN KEY ("project_id") REFERENCES "project" ("id");
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS "attachment" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "parent_attachment_id" INTEGER,
  "uploaded_by" INTEGER NOT NULL,
  "resolution_id" INTEGER,
  "filename" VARCHAR,
  "relative_path" VARCHAR,
  "uploaded_at" TIMESTAMP DEFAULT now(),
  "presentmon_file" BOOLEAN,
  "presentmon_version" VARCHAR,
  "settings" JSON
);

CREATE INDEX IF NOT EXISTS attachment_parent_idx
  ON "attachment" ("parent_attachment_id");

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'attachment_user_fk'
  ) THEN
    ALTER TABLE "attachment"
      ADD CONSTRAINT attachment_user_fk
      FOREIGN KEY ("uploaded_by") REFERENCES "user" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'attachment_resolution_fk'
  ) THEN
    ALTER TABLE "attachment"
      ADD CONSTRAINT attachment_resolution_fk
      FOREIGN KEY ("resolution_id") REFERENCES "resolution" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'attachment_parent_fk'
  ) THEN
    ALTER TABLE "attachment"
      ADD CONSTRAINT attachment_parent_fk
      FOREIGN KEY ("parent_attachment_id") REFERENCES "attachment" ("id");
  END IF;
END $$;

CREATE TABLE IF NOT EXISTS "execution" (
  "id" INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  "device_id" INTEGER NOT NULL,
  "run_id" INTEGER NOT NULL,
  "test_case_version_id" INTEGER NOT NULL,
  "executed_by" INTEGER NOT NULL,
  "status_id" INTEGER NOT NULL,
  "attachment_id" INTEGER,
  "actual_result" TEXT,
  "executed_at" TIMESTAMP,
  "execution_order" INTEGER NOT NULL
);

CREATE UNIQUE INDEX IF NOT EXISTS execution_run_version_unique
  ON "execution" ("run_id", "test_case_version_id");

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'execution_run_fk') THEN
    ALTER TABLE "execution"
      ADD CONSTRAINT execution_run_fk
      FOREIGN KEY ("run_id") REFERENCES "run" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'execution_tcv_fk') THEN
    ALTER TABLE "execution"
      ADD CONSTRAINT execution_tcv_fk
      FOREIGN KEY ("test_case_version_id") REFERENCES "test_case_version" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'execution_status_fk') THEN
    ALTER TABLE "execution"
      ADD CONSTRAINT execution_status_fk
      FOREIGN KEY ("status_id") REFERENCES "status" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'execution_user_fk') THEN
    ALTER TABLE "execution"
      ADD CONSTRAINT execution_user_fk
      FOREIGN KEY ("executed_by") REFERENCES "user" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'execution_device_fk') THEN
    ALTER TABLE "execution"
      ADD CONSTRAINT execution_device_fk
      FOREIGN KEY ("device_id") REFERENCES "device" ("id");
  END IF;
END $$;

DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'execution_attachment_fk') THEN
    ALTER TABLE "execution"
      ADD CONSTRAINT execution_attachment_fk
      FOREIGN KEY ("attachment_id") REFERENCES "attachment" ("id");
  END IF;
END $$;


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/sql/user_queries/get_public_user.sql ---
SELECT id, first_name, last_name, email, user_type_id FROM "user" WHERE email=%s;

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/sql/user_queries/add_user.sql ---
INSERT INTO "user" (first_name, last_name, email, password, user_type_id) VALUES (%s, %s, %s, %s, %s);

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/sql/user_queries/get_private_user.sql ---
SELECT id, first_name, last_name, email, password, user_type_id FROM "user" WHERE email=%s;

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/sql/user_queries/get_private_users.sql ---
SELECT id, first_name, last_name, email, password, user_type_id FROM "user";

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/sql/user_queries/delete_user.sql ---
DELETE FROM "user" WHERE id=%s;

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/sql/user_queries/get_public_users.sql ---
SELECT id, first_name, last_name, email, user_type_id FROM "user";

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/app/__init__.py ---
from flask import Flask
from flask_jwt_extended import JWTManager
from flask_smorest import Api
from config import CONFIG
from .routes import register_routes

config = CONFIG()

def create_app():
    app = Flask(__name__)
    app.url_map.strict_slashes = False
    
    app.config["JWT_SECRET_KEY"] = config["JWT_SECRET_KEY"]
    app.config["API_TITLE"] = "File Management System"
    app.config["API_VERSION"] = "v1"
    app.config["OPENAPI_VERSION"] = "3.0.3"
    app.config["OPENAPI_URL_PREFIX"] = "/"
    app.config["OPENAPI_SWAGGER_UI_PATH"] = "/swagger"
    app.config["OPENAPI_SWAGGER_UI_URL"] = "https://cdn.jsdelivr.net/npm/swagger-ui-dist/"

    jwt = JWTManager(app)

    @app.errorhandler(Exception)
    def handle_exception(e):
        return {
            "status": "error",
            "msg": str(e)
        }, 500

    api = Api(app)
    register_routes(api)

    return app


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/app/schemas/auth.py ---
from marshmallow import Schema, fields

class LoginSchema(Schema):
    email = fields.Email(required=True)
    password = fields.Str(required=True, load_only=True)

class TokenSchema(Schema):
    access_token = fields.Str()


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/app/schemas/user.py ---
from marshmallow import Schema, fields

class UserSchema(Schema):
    id = fields.Int()
    first_name = fields.Str()
    last_name = fields.Str()
    email = fields.Email()
    user_type_id = fields.Int()

class UserCreateSchema(Schema):
    first_name = fields.Str(required=True)
    last_name = fields.Str(required=True)
    email = fields.Email(required=True)
    password = fields.Str(required=True, load_only=True)
    user_type_id = fields.Int(required=True)


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/app/services/users_service.py ---
from sql_loader import SQL_COMMANDS
from auth import hash_password

sql = SQL_COMMANDS()

def get_all_users(cur):
    users = cur.execute(sql['get_public_users']).fetchall()
    return {"status": "success", "msg": [dict(row) for row in users]}

def get_user_by_mail(cur, mail):
    user = cur.execute(sql['get_public_user'], (mail,)).fetchone()
    if user:
        return {"status": "success", "msg": [dict(user)]}
    return {"status": "fail", "msg": "User not found"}

def add_user(cur, data):
    first_name, last_name, email, password, user_type_id = data.get("first_name"), data.get("last_name"), data.get("email"), data.get("password"), data.get("user_type_id")
    hashed_password = hash_password(password)
    cur.execute(sql['add_user'], (first_name, last_name, email, hashed_password, user_type_id))
    return {"status": "success", "msg": f"User {first_name + ' ' + last_name} added"}
def delete_user(cur, data):
    email = data.get("email")
    cur.execute(sql['delete_user'], (email,))
    return {"status": "success", "msg": f"Deleted {email}"}


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/app/services/auth_service.py ---
from sql_loader import SQL_COMMANDS
from auth import authenticate

sql = SQL_COMMANDS()

def authenticate_user(cur, data):
    mail, password = data.get("email"), data.get("password")
    if not mail or not password:
        return {"status": "fail", "msg": "Email and password are required"}

    user = cur.execute(sql['get_private_user'], (mail,)).fetchone()
    if not user:
        return {"status": "fail", "msg": "User not found"}

    if authenticate(password=password, stored_hash_b64=user["password"]):
        return {
            "status": "success", 
            "user": dict(user),
            "msg": "Authentication successful"}
    return {"status": "fail", "msg": "Invalid credentials"}


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/app/services/db_init_service.py ---
from sql_loader import SQL_COMMANDS

sql = SQL_COMMANDS()

def initialize_database(cur):
    try:
        cur.execute(sql["init"])
        return {
            "status": "success",
            "msg": "Database schema initialized successfully",
        }

    except Exception as e:
        return {
            "status": "fail",
            "msg": f"Cannot initialize database. Error: {e}",
        }


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/app/routes/auth.py ---
from flask import request, jsonify
from flask_jwt_extended import create_access_token
from flask_smorest import Blueprint
from app.services.auth_service import authenticate_user
from database.db_utils import db_route
from app.schemas.auth import LoginSchema, TokenSchema

auth_bp = Blueprint(
    "auth",
    "auth",
    url_prefix="/auth",
    description="Authentication"
)

@auth_bp.route("/", methods=["POST"])
@auth_bp.arguments(LoginSchema)
@auth_bp.response(200, TokenSchema)
def login():
    data = request.get_json()
    result = db_route(authenticate_user, data)
    if result["status"] != "success":
        return jsonify(result), 401

    token = create_access_token(
        identity=str(result["user"]["id"]),
        additional_claims={
            "email": result["user"]["email"],
            "user_type_id": result["user"]["user_type_id"]
        }
    )

    return {
        "status": "success",
        "access_token": token
    }



# --- /home/ko_linux/FileManagementTool/FileManagementSystem/app/routes/root.py ---
from flask_smorest import Blueprint

root_bp = Blueprint(
    "root",
    "root",
    url_prefix="/",
    description="Service root"
)

@root_bp.route("/")
def root():
    return {
        "service": "FileManagementSystem",
        "status": "running",
        "docs": "/swagger"
    }


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/app/routes/__init__.py ---
from .users import users_bp
from .auth import auth_bp
from .root import root_bp

def register_routes(app):
    api.register_blueprint(root_bp)
    api.register_blueprint(auth_bp)
    api.register_blueprint(users_bp)


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/app/routes/users.py ---
from flask import request, jsonify
from flask_jwt_extended import jwt_required, get_jwt_identity
from flask_smorest import Blueprint
from database.db_utils import db_route
from app.services.users_service import get_all_users, get_user_by_mail, add_user, delete_user
from app.schemas.user import (
    UserSchema,
    UserCreateSchema
)

users_bp = Blueprint(
    "users",
    "users",
    url_prefix="/users",
    description="User management"
)

@users_bp.route("/", methods=["GET"])
@users_bp.response(200, UserSchema(many=True))
@users_bp.doc(security=[{"bearerAuth": []}])
@jwt_required()
def list_users():
    return db_route(get_all_users)

@users_bp.route("/<string:mail>", methods=["GET"])
@users_bp.response(200, UserSchema(many=True))
@users_bp.doc(security=[{"bearerAuth": []}])
@jwt_required()
def get_user(mail):
    return db_route(get_user_by_mail, mail)

@users_bp.route("/", methods=["POST"])
@users_bp.response(200, UserSchema(many=True))
@users_bp.doc(security=[{"bearerAuth": []}])
@jwt_required()
def create_user():
    data = request.get_json()
    return db_route(add_user, data)

@users_bp.route("/", methods=["DELETE"])
@users_bp.response(200, UserSchema(many=True))
@users_bp.doc(security=[{"bearerAuth": []}])
@jwt_required()
def remove_user():
    data = request.get_json()
    return db_route(delete_user, data)

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/.idea/misc.xml ---
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="Black">
    <option name="sdkName" value="Python 3.12 (PyCharmMiscProject)" />
  </component>
  <component name="ProjectRootManager" version="2" project-jdk-name="Python 3.12 (PyCharmMiscProject)" project-jdk-type="Python SDK" />
</project>

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/.idea/FileManagementSystem.iml ---
<?xml version="1.0" encoding="UTF-8"?>
<module type="PYTHON_MODULE" version="4">
  <component name="NewModuleRootManager">
    <content url="file://$MODULE_DIR$" />
    <orderEntry type="jdk" jdkName="Python 3.12 (PyCharmMiscProject)" jdkType="Python SDK" />
    <orderEntry type="sourceFolder" forTests="false" />
  </component>
  <component name="PyDocumentationSettings">
    <option name="format" value="GOOGLE" />
    <option name="myDocStringFormat" value="Google" />
  </component>
</module>

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/.idea/workspace.xml ---
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="AutoImportSettings">
    <option name="autoReloadType" value="SELECTIVE" />
  </component>
  <component name="ChangeListManager">
    <list default="true" id="677d8d92-d490-46dc-8ed8-a01f9cb718d5" name="Changes" comment="">
      <change beforePath="$PROJECT_DIR$/app/__init__.py" beforeDir="false" afterPath="$PROJECT_DIR$/app/__init__.py" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/app/routes/auth.py" beforeDir="false" afterPath="$PROJECT_DIR$/app/routes/auth.py" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/app/routes/users.py" beforeDir="false" afterPath="$PROJECT_DIR$/app/routes/users.py" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/app/services/db_init_service.py" beforeDir="false" afterPath="$PROJECT_DIR$/app/services/db_init_service.py" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/app/services/users_service.py" beforeDir="false" afterPath="$PROJECT_DIR$/app/services/users_service.py" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/config.json" beforeDir="false" afterPath="$PROJECT_DIR$/config.json" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/config.py" beforeDir="false" afterPath="$PROJECT_DIR$/config.py" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/db.py" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/main.py" beforeDir="false" afterPath="$PROJECT_DIR$/main.py" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/requirements.txt" beforeDir="false" afterPath="$PROJECT_DIR$/requirements.txt" afterDir="false" />
      <change beforePath="$PROJECT_DIR$/sql/client_queries/create_table_clients.sql" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/sql/client_queries/create_table_projects.sql" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/sql/filelist_queries/create_table_filelist.sql" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/sql/hardware_queries/create_table_pclist.sql" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/sql/testcases_queries/create_table_statuses_list.sql" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/sql/testcases_queries/create_table_suitcase_map.sql" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/sql/testcases_queries/create_table_test_cases_repository.sql" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/sql/testcases_queries/create_table_test_cases_run.sql" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/sql/testcases_queries/create_table_test_suite.sql" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/sql/testcases_queries/create_table_test_suite_template.sql" beforeDir="false" />
      <change beforePath="$PROJECT_DIR$/sql/user_queries/create_table_users.sql" beforeDir="false" />
    </list>
    <option name="SHOW_DIALOG" value="false" />
    <option name="HIGHLIGHT_CONFLICTS" value="true" />
    <option name="HIGHLIGHT_NON_ACTIVE_CHANGELIST" value="false" />
    <option name="LAST_RESOLUTION" value="IGNORE" />
  </component>
  <component name="Git.Settings">
    <option name="RECENT_GIT_ROOT_PATH" value="$PROJECT_DIR$/.." />
  </component>
  <component name="ProjectColorInfo"><![CDATA[{
  "associatedIndex": 2
}]]></component>
  <component name="ProjectId" id="387UoF59mDjxEbIrL2hdPQO3Lrz" />
  <component name="ProjectViewState">
    <option name="hideEmptyMiddlePackages" value="true" />
    <option name="showLibraryContents" value="true" />
  </component>
  <component name="PropertiesComponent"><![CDATA[{
  "keyToString": {
    "RunOnceActivity.ShowReadmeOnStart": "true",
    "RunOnceActivity.git.unshallow": "true",
    "git-widget-placeholder": "main",
    "ignore.virus.scanning.warn.message": "true",
    "last_opened_file_path": "//wsl.localhost/Ubuntu/home/ko_linux/FileManagementTool/FileManagementSystem"
  }
}]]></component>
  <component name="SharedIndexes">
    <attachedChunks>
      <set>
        <option value="bundled-python-sdk-4f4e415b4190-aa17d162503b-com.jetbrains.pycharm.community.sharedIndexes.bundled-PC-243.26053.29" />
      </set>
    </attachedChunks>
  </component>
  <component name="SpellCheckerSettings" RuntimeDictionaries="0" Folders="0" CustomDictionaries="0" DefaultDictionary="application-level" UseSingleDictionary="true" transferred="true" />
  <component name="TaskManager">
    <task active="true" id="Default" summary="Default task">
      <changelist id="677d8d92-d490-46dc-8ed8-a01f9cb718d5" name="Changes" comment="" />
      <created>1768150275349</created>
      <option name="number" value="Default" />
      <option name="presentableId" value="Default" />
      <updated>1768150275349</updated>
    </task>
    <servers />
  </component>
</project>

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/.idea/.gitignore ---
# Default ignored files
/shelf/
/workspace.xml


# --- /home/ko_linux/FileManagementTool/FileManagementSystem/.idea/modules.xml ---
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="ProjectModuleManager">
    <modules>
      <module fileurl="file://$PROJECT_DIR$/.idea/FileManagementSystem.iml" filepath="$PROJECT_DIR$/.idea/FileManagementSystem.iml" />
    </modules>
  </component>
</project>

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/.idea/vcs.xml ---
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="VcsDirectoryMappings">
    <mapping directory="$PROJECT_DIR$/.." vcs="Git" />
  </component>
</project>

# --- /home/ko_linux/FileManagementTool/FileManagementSystem/.idea/inspectionProfiles/profiles_settings.xml ---
<component name="InspectionProjectProfileManager">
  <settings>
    <option name="USE_PROJECT_PROFILE" value="false" />
    <version value="1.0" />
  </settings>
</component>

